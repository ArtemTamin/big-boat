<?php// no direct accessdefined('_JEXEC') or die('Restricted access');jimport('joomla.plugin.plugin');jimport('joomla.html.parameter');jimport('joomla.application.component.controller');jimport('joomla.filesystem.file');if(!class_exists("JshoppingControllerBase") && JRequest::getInt("extended") == 1) { //fix JS 4.11 compatibility	if (!defined('DS')) define( 'DS', DIRECTORY_SEPARATOR);	if (!defined('JPATH_COMPONENT')) define( 'JPATH_COMPONENT',	JPATH_BASE.DS.'components'.DS.'com_jshopping');	if (!defined('JPATH_COMPONENT_SITE')) define( 'JPATH_COMPONENT_SITE', JPATH_SITE.DS.'components'.DS.'com_jshopping');	if (!defined('JPATH_COMPONENT_ADMINISTRATOR')) define( 'JPATH_COMPONENT_ADMINISTRATOR',	JPATH_ADMINISTRATOR.DS.'components'.DS.'com_jshopping');	jimport('joomla.application.component.model');	JModelLegacy::addIncludePath(JPATH_COMPONENT_SITE.'/models');	require_once(JPATH_COMPONENT_SITE."/lib/factory.php");	require_once(JPATH_COMPONENT_SITE.'/controllers/base.php');	$controller = getJsFrontRequestController();	require(JPATH_COMPONENT_SITE."/loadparams.php");}class plgSystemJSFilter extends JPlugin {	function plgSystemJshopefilter(&$subject, $config) {		parent::__construct($subject, $config);	}		function onAfterRoute() {						if(!JFile::exists(JPATH_ROOT."/components/com_jshopping/lib/factory.php")) {				echo "Joomshopping does not installed. ";				return;			}						ini_set("memory_limit", "400M");			ini_set("max_execution_time", "300"); 			ini_set("display_errors", "On");			error_reporting(E_ALL & ~E_STRICT & ~E_NOTICE & ~E_WARNING & ~E_DEPRECATED);						// Define the DS constant under Joomla! 3.0			if (!defined('DS')) define('DS', DIRECTORY_SEPARATOR);						$option = JRequest::getVar("option");			$controller = JRequest::getVar("controller");			$task = JRequest::getVar("task");									if($option == "com_jshopping" && $controller == "search" && $task == "result" && JRequest::getInt("extended") == 1) {									if (!defined('JPATH_COMPONENT')) define( 'JPATH_COMPONENT',	JPATH_BASE.DS.'components'.DS.'com_jshopping');				if (!defined('JPATH_COMPONENT_SITE')) define( 'JPATH_COMPONENT_SITE', JPATH_SITE.DS.'components'.DS.'com_jshopping');				if (!defined('JPATH_COMPONENT_ADMINISTRATOR')) define( 'JPATH_COMPONENT_ADMINISTRATOR',	JPATH_ADMINISTRATOR.DS.'components'.DS.'com_jshopping');								$pluginPath = JPATH_BASE.DS.'plugins'.DS.'system'.DS.'jsfilter'.DS.'jsfilter';								require_once (JPATH_SITE.DS.'components'.DS.'com_jshopping'.DS.'controllers'.DS.'search.php');				$controller = new JshoppingControllerSearch;					$config['name'] =  "search";				$config['default_task'] =  "display";				$config['base_path'] =  $pluginPath;				$config['model_path'] =  $pluginPath.DS."models";				$config['view_path'] =  $pluginPath.DS."views";				$config['template_path'] = JPATH_COMPONENT."/templates/".$this->getJShopTemplate()."/category";									$controller->__construct($config);								$format = JRequest::getVar("tmpl", "");				switch($format) {					case "count" :						$view = $controller->getView("search", "count", "", $config);					break;										default :						$view = $controller->getView("search", "html", "", $config);				}							}				} 		function onBeforeDisplayProductListView($view) {		if($view->results_template == "category") {			$filterLang = JFactory::getLanguage();			$filterLang->load("mod_jshopping_extended_filter");						require_once (JPATH_SITE.DS.'modules'.DS.'mod_jshopping_extended_filter'.DS.'helper.php');			$moduleId = JRequest::getVar("moduleId");			$moduleParams = modJShopExtendedFilterHelper::getModuleParams($moduleId);						if (count($view->rows)) {				echo "<div class='results-text'><p>" . $moduleParams->search_results_text . "(" . $view->results_total . ") :</p></div>";			}			else {				echo "<div class='results-text'><p>" . $moduleParams->text_no_results . "</p></div>";			}		}	}		function onBeforeQueryGetProductList($view, &$adv_result, &$adv_from, &$adv_query, &$order_query, &$filters) {		if(JRequest::getInt("extended") == 1) {			$adv_query = '';		}	}		function getJShopTemplate() {		$db = JFactory::getDBO();		$query = "SELECT template FROM #__jshopping_config";		$db->setQuery($query);				$result = $db->loadResult();		if($result == "") {			return "default";		}		return $result;	}} // class?>